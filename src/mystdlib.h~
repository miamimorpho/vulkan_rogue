
struct MyBufferMeta{
    size_t top;
    size_t size;
}

struct MyBufferMeta* myBufferMeta(void* buffer){
    return ( ( struct MyBufferMeta*)buffer ) - 1;
}

void* myBufferMalloc(size_t nmemb, size_t stride){
    if(stride && nmemb > SIZE_MAX / stride){
        fprintf(stderr, "MyBufferMalloc:integer overflow\n");
        return NULL;
    }
    
    struct MyBufferMeta* info_ptr = 
        malloc( sizeof(MyBufferMeta) + stride * nmemb);
    if(info_ptr == NULL){
        fprintf(stderr, "MyBufferMalloc:malloc error\n");
        return NULL;
    }
    info_ptr->top = 0;
    info_ptr->size = stride * nmemb;

    return (void*)(info_ptr +1);
}

void myBufferFree(void* raw_ptr){
    if(raw_ptr == NULL) return;
    free(myBufferMeta(raw_ptr));
}

int myBufferPush(void* root_ptr, void* val_ptr, size_t stride)
{
    struct MyBufferMeta* info = myBufferMeta(root_ptr);
    if(info->top >= info->size / stride) return -1;

    memcpy((char*)root_ptr + (info->top * stride), 
           val_ptr, stride);
    info->top++;
    return 0;
}

int myBufferPop(void* root_ptr){
    struct MyBufferMeta* info = myBufferMeta(root_ptr);
    if(info->top == 0) return -1;

    info->top--;
    return 0;
}
